#!/bin/bash

true <<'EOF'
=pod

=head1 NAME

lpjobs - Show printer queue jobs (wrapper for lpq and lpstat)

=cut

EOF


TAB=$'\t'

lpq_short_list_to_td()
{
	# lpq prints in "%-7s %-7.7s %-7d %-31.31s %.0f bytes" format,
	# so we insert tabs in netween the fields.
	perl -ne 'print join("\t", map {s/\s*$//r} /^(.{7}) (.{7}) (.{7}) (.{31}) (\S+)/), "\n"'
}

LANG=C lpq -a |\
sed -e '/^no entries$/ d' |\
lpq_short_list_to_td |\
ifne td-select -H Job Rank 'File(s)' |\
{
	declare -a job_rank
	declare -a job_filename
	declare -a job_printer
	declare -a job_datetime
	declare -A jobs
	
	while read -r jobid rank filename
	do
		job_rank[$jobid]=$rank
		job_filename[$jobid]=$filename
		jobs[$jobid]=1
	done
	
	LANG=C lpstat -o | td-trans -c 4 |\
	td-add-headers -X PRINTERJOBID USER SIZE DATETIME |\
	td-alter _='($printer, $jobid) = PRINTERJOBID =~ /^(.+?)-(\d+)$/' PRINTER='$printer' JOBID='$jobid' |\
	ifne td-select -H JOBID PRINTER DATETIME |\
	{
		while read -r jobid printer datetime
		do
			job_printer[$jobid]=$printer
			job_datetime[$jobid]=$datetime
			jobs[$jobid]=1
		done
		
		echo "JOB${TAB}PRINTER${TAB}RANK${TAB}DATETIME${TAB}FILE"
		
		for jobid in `printf '%s\n' "${!jobs[@]}" | sort -n`
		do
			echo "$jobid${TAB}${job_printer[$jobid]}${TAB}${job_rank[$jobid]}${TAB}${job_datetime[$jobid]}${TAB}${job_filename[$jobid]}"
		done
	}
}
