#!/usr/bin/env perl5.18-or-later

use Data::Dumper;
use Getopt::Long;
use Perl::Tokenizer;

do $ENV{'PERL5LIB_ROOT'}."/usr/lib/tdat/common.pl";


GetOptions(
	'F=s' => \$IFS,
) or
die "Usage: $0 [<OPTIONS>] <FILTER>
OPTIONS:
  -F REGEX   input field separator (default: $IFS)
\n";


my $header = <STDIN>;
print $header;
my @COLUMNS = parse_column_headers($header);
undef $header;


# take arguments as perl expression and transform bare words to variables referring to the input fields
my $filter_expr = join ' ', @ARGV;
my $FILTER_CODE = transform_to_perl_expression 'FIELD', $filter_expr;
undef $filter_expr;
if($ENV{'TDSEL_DEBUG'}) { warn "filter code: $FILTER_CODE\n"; }


# filter input
while(<STDIN>)
{
	my $do_show = 0;
	
	my %FIELD = parse_record($_, @COLUMNS);
	
	my $match = eval $FILTER_CODE;
	die $@ if $@;
	if($match) { $do_show = 1; }
	
	if($do_show)
	{
		print;
	}
}
